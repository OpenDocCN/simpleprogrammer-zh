# 回到基础:模仿消除模式

> 原文：<https://simpleprogrammer.com/back-to-basics-mock-eliminating-patterns/>

在我之前的文章中，我谈到了没有模拟的单元测试。我在来自 [PaceMaker](http://www.appbrain.com/app/pacemaker-(running)/com.pacemaker.android) 的一些真实代码中给出了一些我是如何做到这一点的例子。

这一次，我想看看一些常见的模式，我们可以使用这些模式将部分代码提取到依赖精简版或无依赖类中，这样我们就可以进行单元测试，而不需要模拟。

我不得不承认，我已经很久没有实践这种方法了，所以我的模式列表可能会有所欠缺，但是这些是我在研究代码时不断看到的一些模式。

如果你对其他模式有一些想法，或者已经知道一些，或者有比我选择的更好的名字，请让我知道。

## 模式 1:拉出状态

在许多情况下，我们可以拥有包含其自身状态的复杂对象，这些复杂对象通常跨成员变量进行拆分。

如果您发现一个类有许多方法来检查某个成员变量，并根据该成员变量被设置为什么值来做这样或那样的事情，那么通过将所有状态改变逻辑提取到一个单独的类中，并在状态改变时创建事件来通知原始类，您可能会从中受益。

然后，我们可以将新类作为它所来自的类的单一状态源，并轻松地为 state 类编写无依赖性(2 级)单元测试。

从你要脱离的阶级的角度来看，我们可能会转向:

变成:

显然，在这种情况下，状态会有很多种变化方式。我在这里没有包括这些，但是你可以想象这些将如何成为新的 state 类的一部分。



![attack-penguin](img/62eab15005a1af498c09a4c555b2e6e8.png "attack-penguin")



## 模式 2:类的方法

我经常发现，由于类内部的多重交互，我无法找到一种方法将一个类中的所有逻辑提取到一个内聚的类中。

当我遇到这个问题时，我发现我通常可以识别出一个使用类中依赖关系的数据来执行其逻辑的大型方法。

这些方法通常可以被提取出来成为它们自己的新类。我们可以从方法最初使用的依赖关系中传递数据，而不是直接使用依赖关系。

这种模式的良好候选是使用多个依赖项来获取数据以便计算单个结果的方法。

当应用这种模式时，我们可能会得到一个非常小的类，只包含 1 或 2 个方法，但是我们能够很容易地用与状态和依赖无关的单元测试(级别 1。)

## 模式 3:拉起数据源

通常情况下，我们在一个类中有依赖关系，它们的存在只是为了给类中的实际逻辑提供某种数据。

在这些情况下，通常可以将数据源从使用数据的方法中取出，而只传入使用过的数据。

执行这种重构允许我们在类中拥有不直接使用类中依赖项的方法，而是传递依赖类提供的数据。

当我们这样做时，它提供了编写干净简单的单元测试的能力，而不用模仿类中的那些方法，或者应用“方法到类”的模式将方法提取到它自己的可测试类中。

作为重构代码以使其易于单元测试的第一步，我将经常扫描类中的方法，以找到仅使用依赖项中的数据，但不操纵状态或向依赖项发送命令的方法。因为我能够识别这些方法，所以我可以应用这个模式从这些方法中移除依赖项。

## 模式 4:收集然后使用

我们经常发现我们不能从一个方法中取出一个依赖项，因为这个依赖项是在一个循环中或者在某个过程中被操纵的。

在这种情况下，我们通常可以以某种形式的集合收集所有用于操作依赖项的数据，然后通过该集合重复执行对依赖项的操作。

设想这一点的一个好方法是想象两个人在邮寄信件。在一个场景中，我们可能让第一个人填充信封，第二个人密封信封。

我们可以继续这个过程，第一个家伙的东西，第二个家伙为我们想要邮寄的每封信盖章，但这个过程取决于这两个人在场和工作。

如果我们改变一下，让第一个人先把所有的信封装好，然后把那叠装好的信封交给第二个人，他们就可以独立完成工作了。

通过将同样的思想应用于我们代码中的算法，我们可以采用单个方法，将不依赖于依赖关系的部分分离出来进行独立测试，甚至移动到它们自己的类中。