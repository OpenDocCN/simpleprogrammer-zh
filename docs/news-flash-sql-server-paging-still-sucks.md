# 新闻快讯:SQL Server 分页仍然很糟糕！

> 原文:[https://simple programmer . com/news-flash-SQL-server-paging-still-sucks/](https://simpleprogrammer.com/news-flash-sql-server-paging-still-sucks/)

上次我写了一些代码来允许在 SQL Server 中对存储过程结果进行分页，结果很糟糕。

那是大约 3-4 年前的事了。

我只是写了一些代码再做一次，嗯…还是很烂。

也许我做错了，但是如果你正在寻找“如何在 sql server 中实现分页”，或者“如何对 sql server 存储过程结果进行分页”，或者“sql server 分页”，我会在这一点上给你我的最佳答案。



![paging](img/aa0f66a369f2a77d457dd0bd828322f6.png "paging")



## 我如何与 cte 合作

cte 或公共表表达式是 SQL Server 的一个非常好的特性。它们有点复杂，但基本上它们允许您创建一个查询，并将其视为一个可供选择的表。它们还允许对自身进行递归调用，这让您可以做一些很酷的事情，比如查询数据的层次结构。

这个链接很好地解释了 cte。

无论如何，cte 与 ROW_NUMBER()函数结合使用，可以方便地增加从现有存储过程中分页数据的能力。

这里的基本思想是通过将原始查询包装在添加了 RowNumber 列的 CTE 中来修改它。

然后，我们可以从该查询中选择我们想要的范围内的行。

## 蔬菜对你有好处

让我们看一个例子:

现在让我们把这个查询修改成可分页的，因为我们已经得到了我们想要的第一条和最后一条记录。(第一条记录=页码*每页行数，最后一条记录=页码+ 1 *每页行数)

好吧，其实没那么糟。

一些注释有助于理解这里发生的事情。

*   ROW_NUMBER()需要一个 OVER 子句，它基本上决定了如何计算行号。在这种情况下，我们将按名称排序。因此，第一个字母名称将是第 1 行，依此类推。
*   我们将查询包装在一个 CTE 中，并添加了一个额外的列，这样我们在新的虚拟表中就有了一个行号。(想象一下 CTE 为我们创造了一个暂时的视角。)
*   我们从原始查询中选择我们想要的行范围内的所有内容。(根据您定义范围的方式，您可以使用不同的等式运算符。如果您的范围是包含性的，您将做<= and > =，如果是排他性的，它将是< and >。在这种情况下，我们都是。)

## 关于总行数的一句话

如果您需要总行数，以便在代码中将它传递回页面调度器，那么您可能需要将 CTE 中的结果选择到一个临时表中，并从中返回两个结果集。

我真的找不到从单个 CTE 表达式中选择总行数和数据的方法。如果你知道一个方法，请让我知道。