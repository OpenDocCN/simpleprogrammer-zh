# 在 Microsoft Excel 中使用 VBA 实现数据分析自动化

> 原文：<https://simpleprogrammer.com/vba-data-analysis-automation/>

Visual Basic for Applications (VBA)可以用来[自动化任何微软 Office (MS Office)产品中的几乎任何东西](https://simpleprogrammer.com/2017/08/28/maximizing-efficiency-vba/)。如果您对 VBA 有基本的了解，但还没有明确的应用程序，本文将提供真实的、实用的完整 VBA 过程示例，将整个业务流程转变为单击一个按钮。

我将带您创建一个组合键，并从一个文件中找到与主文件中的记录相匹配的所有记录，然后我们将使用几个数据透视表来分析不匹配的记录，以帮助进行模式识别。

比学习代码更重要的是学习正确的心态，让 VBA 为你工作。VBA 可以节省你的时间，让你成为工作中的摇滚明星，但正如任何强大的力量一样，你需要明智地使用它。我们将讨论当你开始与 VBA 合作时发生的根本思维转变，以及如何让这种思维为你和你的公司服务。

## “宏观思维”

![](img/78ad910fbb289a51cef35dccb681a568.png)

一旦你成功地自动化了与你在 VBA 的工作相关的任何事情，你就可能对 MS Office 产品，尤其是 Excel，有了全新的看法(没有双关语的意思)。这种新的思维模式是理解这些应用程序的对象层次的结果，甚至是有效使用宏记录器的结果。

一旦您理解了宏的工作原理，您就可以开始寻找更多的宏项目，这些宏项目可能会节省您大量的时间。由于宏被定义为一种将输入参数映射到输出参数的方法，通常是为了自动化工作，那么描述您的思维模式从基本的“手动思维模式”到“宏思维模式”的转变是合适的。

如果你不把这种新的宏观思维模式运用到商业运作的环境中，它会带来问题。当然，如果你能自动化每一个涉及 Excel 的任务就好了，但是机会成本是多少呢？

你必须记住的两点是:“需要多长时间？”以及“在另一个应用程序中，我们已经拥有或在不久的将来将拥有的功能是否会重叠？”

让我们看看如何知道什么时候使用 VBA 是正确的做法。

## 理解自动化项目的背景

与任何项目一样，您需要做的第一件事是理解您想要自动化的过程的上下文。构建一个时间表来帮助澄清每个解决方案的期限估计和预期寿命。

确保您了解使用 VBA 流程作为解决方案的风险，以及任何可能的替代方案。例如，如果你的部门正在投资一个新的商业智能工具来解决这个问题，那么你应该在编写任何 VBA 代码之前调查这个工具。

看看你的时间线。计算完成 VBA 脚本需要多长时间，手动执行该任务需要多长时间，以及该任务将存在多长时间。这个业务流程会在几个月后发生巨大的变化吗？这样的变化会破坏您的代码吗？

IT 采购和资源分配方面的决策可能会缩短代码的预期寿命。换句话说，要明白，开发 VBA 解决方案存在浪费时间的风险，该解决方案要么在几周内被商业智能工具所取代，要么因为不可预见的业务流程变化而变得过时(例如，业务流程特定于您正在合作的客户，他们终止了与您公司的协议)。

由于商业智能工具许可证可能会花费数千美元，而且大多数公司默认使用 MS Office，我认为启动一个 VBA 项目，发现它不再可行，然后彻底放弃它的风险要小得多。或者，您可以调查一个新的商业智能工具的功能，花几个小时培训自己如何使用它，然后发现它存在兼容性问题(或其他未预料到的限制)。

关于环境的最后一句话:如果你的目标是找到使用 VBA 的最大机会，你会在小公司、正在裁员的公司，甚至是低预算运营的大公司的部门中找到它们。一般来说，试图省钱的公司和部门更容易接受使用 VBA 作为解决方案。

在选择[VBA 路径](http://www.dummies.com/programming/visual-basic/defining-vba-and-its-uses/)时，请记住这些一般规则:

1.  当省钱是重中之重时，VBA 解决方案是理想之选。
2.  VBA 解决方案非常灵活。
3.  VBA 解决方案最好由尽可能少的用户维护和使用。
4.  绝大多数 VBA 解决方案都是用 Excel 编写的。
5.  小公司通常比大公司有更多的机会进入 VBA。
6.  VBA 解决方案的稳健程度取决于您的创造。

宏和 VBA 的要点是节省时间(是的，增加功能，但我们在这里的重点是时间)，所以只要你真的在节省时间，那么宏的思维将为你工作，而不是与你作对。

现在，让我们看一些实际的代码。

## 示例 1:产品代码查找过程

![](img/aed07f3700023741cbaf02785835a758.png)

对于那些刚接触 VBA 的人来说，过程是一系列可独立执行的 VBA 语句。

此示例过程的基本思想是找出 ProductReport 文件中的产品是否包含新的项目目录类别的产品规格代码(即，主文件中当前不存在的产品规格)，如果是，它们是哪些行项目，有多少个？

对于这个例子，我使用一个文本文件 ProductReport 来表示第三方报告。基线文件是存储历史产品信息的 Excel 工作簿。

我建议先完整扫描一下 GitHub 上的“ProdCodeLookup2”代码。我将在接下来的部分中对其进行分解。

### ProdCodeLookup2 分解

也许解决问题最重要的部分是将问题分解成几个部分并有条不紊地解决它们的能力。对我来说，最自然的方法是根据用户手动执行任务的顺序来编写每个代码块。

后来，我基于对对象模型的更复杂的理解来改进我的过程，并使用相当少的代码重写它。(出于性能和可读性的原因，您可能希望改变这些任务的完成顺序。坚持这个想法，因为我们稍后将回到它。)

这里是第一个可管理的代码块:

请注意，过程的名称遵循 Pascal 大小写，并以版本号结尾，这在您发现编写代码的替代方法时非常有用。当你在排除故障时，意识到你忘记切换到修订版，并且你犯的错误破坏了你原来的、以前工作的代码，这是非常痛苦的！因此，请始终保持您的程序的最新工作副本。

我(以及大多数在[栈溢出](http://www.stackoverflow.com)的人)写的第一条语句(第 5 行)纯粹是为了提高性能。ScreenUpdating 是 Application 对象的一个属性，它控制屏幕是否实时更新宏正在执行的操作。通过关闭 ScreenUpdating 属性，在代码运行结束之前，您不会看到这种神奇的效果，但是一旦进入循环，您会注意到运行时明显加快了。虽然我没有将该属性设置回 True，但在代码的最后这样做可能是个好主意(除非您有理由不这样做)。

现在，请见证我非凡的创造力和智慧，如以下变量名所示:

好吧，这些名字可能不机智或有创意，但当你开始调试代码时，你不想要机智和有创意。当出现问题时，简单和描述性的变量名将会挽救局面。

我发现根据变量的数据类型和功能(也就是我使用它们的方式)对它们进行分组会更容易管理变量。例如，所有以 rng 开头的范围变量对于控制我如何找到我想要处理的表的哪些列和部分以及在什么时候处理都是必不可少的。

还值得注意的是，我所有的查找变量都是在彼此附近定义的。一旦您开始编写较长的过程，为它们添加注释并为每个过程保留一个新行和“Dim”关键字可能会有所帮助。

养成这样的习惯会让你在排除故障或更新代码时更容易。例如，下面是按照我描述的风格重写的同一个块:

你明白了。只需将变量名写成描述如何使用它的单词或短语。这部分相当简单，但理解起来非常重要。

将工作簿和工作表的名称赋给对象变量。这个操作有很多好处，包括性能和可读性。随着您对 VBA 越来越熟悉，您可能会选择退出这种实践——主要目标是确保故障排除和维护您的代码尽可能容易。如果您和未来的用户不会从这种实践中受益，那么可以随意省略它。

[将工作簿和工作表变量分配给对象](http://spreadsheetpage.com/index.php/tip/using_object_variables/)，就像这样(是的，顺序很重要——首先是工作簿，因为它们是父对象):

由于我无法超越他精彩简洁的解释，这里有一个到 John Walkenbach 网站的链接和一个简短的描述，告诉你关于对象变量你需要知道的一切。

让我们看看下一部分(第 25-30 行):

StartTime 是保存计时器属性初始值的变量(VBA 的成员。DateTime 对象)，并将在最后用于计算总运行时间。如果需要，您可以为可能需要多次引用的较长字符串值创建短变量。“ICC”和“PC”变量体现了这一概念。

最后，本节的最后一行定义了下面几行代码的范围。(您肯定*而不是*希望编译器猜测使用哪个工作簿或工作表，所以一定要指定它。)

在创建“ProdCombo”组合键之前，需要进行一些准备和格式化操作(第 31-42 行)。隐藏基线工作簿中与此过程无关的列，创建我们关心的新列，并在所有标题上应用粗体格式以提高可读性。

在第 44 到 52 行，打开对所有标题的过滤，然后过滤掉除标签之外的所有内容(假设我们只对这个产品规格感兴趣)。

在第 53 到 69 行中，我使用一个循环创建了 ProdCombo，将五列中的值连接起来，并使用一个空格分隔符。

删除空白产品很重要，这是第 70 到 78 行的目的。出于本例的目的，由于我们只关心在五个字段中至少有一个字段有值的产品，所以我们不需要所有五个标签字段都为空的记录。

请注意第 80 行的注释，该注释涉及运行另一个过程:“现在运行 ProdCodeLookup2 过程。”

我最初编写并测试了两个独立的程序；一个用于格式化和其他辅助任务，另一个用于执行 VLOOKUP。我不一定建议您也这样做，但是由于这是我第一次在循环中使用 VLOOKUP，我发现用这种方式开发更容易。ProdCodeLookup2 过程对指定标题下的每个单元格执行 VLOOKUP，并遍历所有记录，直到到达表的末尾。

在我们看第二个例子之前，让我们来谈谈在 VBA 处理 VLOOKUPs 的一些技巧。

## 在 vba 中处理查找的提示

空白和错误(基本上是从 VLOOKUP 函数返回默认错误状态的任何东西，您可以手动执行)将导致整个过程崩溃。是的，这是正确的。当您在 VBA 使用 VLOOKUP 时，这种做法几乎会迫使您在代码中实现错误处理。

关于 VLOOKUPs 的错误处理，至少有一个有用的例子。像我在示例中所做的那样，将包含该函数的循环放在第 83 行和第 96 行，这样就以简单的方式解决了问题。

然后在最后几行(98-109)，执行以下任务:

1.  基于列名定义 ProdCode 列标题位置。
2.  对 ProdCode 下的所有值使用工作表函数“count ”,并将它们赋给一个变量。
3.  在消息框中将结果返回给用户。
4.  重新打开屏幕更新。
5.  返回应用程序运行的时间(秒)。
6.  在消息框中向用户显示时间。

VBA 的第一个剧本到此结束。所以，在这一点上，你可能想知道，“嘿！数据分析在哪里？”

## 数据分析:样本 2

好的，这些信息是有用的，但是其他产品呢？这些结果与其他规范类别(除了标签)相比如何，什么类型的比较值得我们关注？对于所有不匹配的产品，我们能了解到什么？

为了让事情变得更加复杂和有趣，让我们给产品添加一个状态标志。该状态表示有问题的产品规格代码是否处于活动状态。

简要回顾一下，我们的分析维度可以恰当地概括为“产品类别”、“活动/非活动状态”和“匹配/不匹配状态”有了这些额外的细节，我们就有了几个通过[数据透视表](https://fiveminutelessons.com/learn-microsoft-excel/how-create-pivot-table-excel)进行数据可视化的用例。

你会问，数据分析在哪里？就在这里，在一个单独的程序中:

这是一个使用数据透视表的较长过程。仅这两个特征就足以证明，当您编写自己的版本时，需要记住一个简短的提示列表:

1.  **忌”。选择“**:尽量避免使用“”。选择“方法或”。选择”对象，主要是出于性能原因。尝试查找您正在选择的方法和属性，并思考如何避免选择它们。
2.  **尝试记录宏**:除了常用的方法、对象和属性之外，记录宏特性将允许您快速学习一些基本的语法。
3.  写注释:花时间给变量起一个有意义的名字，并且始终如一地使用空格，这是让你的代码更易读的非常有用的方法。随着您编写越来越复杂和冗长的过程，相关的好处将变得显而易见。
4.  **表现**:我将提到几个简单但非常有效的表现技巧，它们会在你进步的过程中产生巨大的影响。VB 编辑器利用了一种叫做“点处理”的东西，这实质上意味着它根据句点(点)来解析你的 VBA 代码。通过减少点的数量，可以最大限度地减少需要编译的语句数量。同样，当您提高程序的规模和复杂性时，这一过程将对您有相当大的帮助。
5.  **学习 R1C1 单元格引用**:由于宏记录器使用它，你应该知道如何阅读它，并且熟悉这种引用样式——特别是为了学习数据透视表在 VBA 是如何工作的。

你还记得我告诉你要坚持的想法吗(即，改变你编程任务的顺序，而不是手动执行的顺序)？现在是重温这一思想的时候了。

在我编写“ProdFlag_v3”过程时，我发现复制、粘贴和删除操作有问题。我真的不明白。“CutCopyMode”属性起作用，我需要让代码起作用——而且要快。

幸运的是，我在这个过程中学到了宝贵的一课:

手动执行动作的顺序不一定是在 VBA 中应该执行的顺序。

虽然理解如何手动执行任务是有好处的，但关键的考虑是不要让这限制了您的思维——这样的限制将导致包含不必要命令的低效代码。

在这个例子中(第 1-36 行)，我们将空白(或者，“NoSpec”或“Spec-less”)记录复制到一个新的工作簿中进行分析。最初，我认为最简单的方法是将报告中的所有内容复制到分析表中，然后过滤掉不需要的数据。由于我已经学会了艰难的方式，它可以更简单地先过滤。

在编写了代码描述并声明了变量之后，您应该注意第 18、20 和 21 行。将 PRtable 对象变量视为由指定工作表上给定区域的左上角和右下角定义的引用。

我特意选择单元格“A1 ”,因为我知道报表上所有最重要的数据都从第一列开始。稍后我将介绍一种使这种动态化的方法。

第 20 行和第 21 行表示创建新工作表的语法。因为我将这个宏存储在包含分析结果的同一个工作簿中，所以在运行这个宏之前，我只需确保它“具有焦点”(即“是活动的”)。

第 23 行到第 25 行声明先前创建的工作表的对象变量，为“FinalRow”变量赋值，并向导出工作表添加自动筛选。下面的块(第 27-30 行)由一个“For-Each”循环组成，该循环过滤掉包含 Spec 数据的列中记录的所有内容，除了空白。

由第 32 到 36 行组成的代码块负责工作簿之间的复制和粘贴。请注意我定义要复制的数据选择的方式(不使用。Select):第 32 行包含一个非常有用的”。Resize "方法有两个参数，PRTableRows 变量和数字 7，它们分别表示我要复制的行数和列数。

如果您想知道，第 38 行不是一个错误；我故意在这里重新分配了 FinalRow 值，因为它需要被重置。还记得第 28 行是怎么用的吗？在“For-Each”循环结束时，它的值等于该表中的列数，这不是我们希望它在下一个循环中使用的值。如果你不在循环之间重置它，你会得到一些非常奇怪的结果！

出于美观的原因(和实践)，我添加了第 39 到 50 行来创建一个 For-Each 循环，其中嵌套了一个 With/End-With 语句。该代码主要根据记录被标记为活动还是非活动来更改值的颜色和字体。此时，我需要澄清一个重要的细节以避免混淆。

活动/非活动状态标志没有被编程到代码中；它被写在基线数据中。如果您创建了自己的标志，您可以比较与我的活动/非活动标志相关联的逻辑，并为您自己的目的模拟它。

我打开了第 52 行的 AutoFilter 属性，然后动态搜索我感兴趣的第一个标题(项目状态列，即状态标志)，并将其分配给一个对象变量。

第 53 到 55 行帮助我们搜索一个范围内的所有单元格，并根据其文本值找到一个单元格:

为了节省时间，我希望大家关注这份声明的两个重要部分:

1.  中的“LookAt”参数。方法有两个常量:“xlPart”和“xlWhole”如果您使用“xlPart”，那么该方法将搜索该范围内的所有单元格，并在包含您正在使用的字符串的第一个单元格处停止。如果您的标题中可能多次包含同一个单词，您就不要使用“xlPart ”,因为如果顺序改变，它可能会选择错误的标题。出于这个原因，我强烈建议坚持使用“xlWhole”
2.  用工作表名称限定范围。即使是 ActiveSheet 也比没有资格好；这是一种最佳实践方法，会让您的生活更轻松。

VLOOKUPs 并不是 VBA 中唯一有用的工作表函数。在第 57 行和第 58 行，我使用“CountIf”函数搜索项目状态列中的所有值，并将结果分配给相应的活动和非活动变量。如果您跳到第 204 到 206 行的 message box 语句，我使用这些变量将结果返回给那里的用户。

我不是一个接一个地浏览每个数据透视表，而是通过总结过程并向您解释编程数据透视表的技巧来节省我们双方的大量时间。

## 在 VBA 使用数据透视表

![](img/a8bd6692a9832677ba8cf0b228ee0ffb.png)

在 VBA 中，数据透视表的先决条件在概念上与手动创建数据透视表的用户是相同的:检查以确保数据源包含有效的、规范化的、高质量的数据。在我的特殊例子(示例 2)中，同样适用:为假想的产品、其类别和规格创建测试数据。

你准备好学习魔法了吗？您将了解如何自动化 Excel 中最广泛使用的高级功能之一。好了，我们开始吧:

1.  复制我使用的两行代码(第 63 行和第 64 行)。
2.  导航到您的工作簿，单击“开发人员”选项卡，然后单击“录制宏”
3.  左键单击表格中要用于透视数据的一个单元格，然后按“Ctrl”+“A”选择所有单元格。
4.  按“Alt”+“N”+“V”+“Enter”(或者在按“Enter”之前更改一些设置)。
5.  手动创建数据透视表，方法是将所需的列拖到适当的维度中，进行筛选、分组、设置值的格式等。
6.  再次单击“录制宏”按钮。
7.  按“Alt”+“F11”回到 VB 编辑器窗口，在你记录的模块中找到代码。
8.  复制它，将其粘贴到您创建的工作表下的项目中，然后阅读它。
9.  根据您的需要，重复创建尽可能多的数据透视表和工作表。

你放心了吗？重点是你不必过多考虑数据透视表对象和方法；如果您对传递变量或更改常量感兴趣，那么当您用记录器手动完成一次，然后读几次代码时，自动化数据透视表确实是最有效的。

将此过程与编程 V-LOOKUPS 的过程进行比较，V-LOOKUPS 需要错误处理、分配给对象变量(并由工作表对象限定)并包含在循环中的精心定义的表或范围。没有一个是宏记录器友好的！

如果你期望更多地使用宏记录器(即使它只用于数据透视表)，我还有一个建议…

## 帮自己一个忙:学习 R1C1 风格

这可能不是您习惯的单元格引用样式，但 R1C1 是宏记录器使用的样式。我建议您熟悉它，以便在使用数据透视表时节省时间，特别是，这样您在编辑从宏记录器生成的代码时就可以减少工作量。

从现在开始，由您来决定哪些数据透视表对象值得在 VBA 学习。事实是，一旦您理解了一些键盘快捷键，如何正确设置您的表，以及如何准备您的代码来插入记录的数据透视表块，您就可以在几分钟内自动完成包含 20 个数据透视表的工作簿。

## 有效分配你的时间

自动化分析的两个最重要的部分(以最有效的方式进行)如下:

1.  你的大部分精力应该花在准备数据上。确保数据质量是一流的，并考虑您可能要使用的任何标志、键、验证、协调和简单计算。
2.  在构建和优化表格时，将最终结果可视化。

我打赌你在这一点上感到惊讶。您可能没有想到本文对构建数据透视表、图表以及其他可能用于数据分析的对象和属性所涉及的实际 VBA 代码关注如此之少。

学习创建数据透视表所需的所有代码并不能节省你的大部分时间——这是一项非常耗时的任务。相反，学习如何准备数据集并自动完成准备过程。

同样，使用 VBA 可以节省你的时间和精力，但是有效而明智地使用它对你的帮助最大。