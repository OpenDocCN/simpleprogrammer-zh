# Android 中单元测试的最佳方式:第 1 部分

> 原文:[https://simple programmer . com/the-best-way-to-unit-test-in-Android/](https://simpleprogrammer.com/the-best-way-to-unit-test-in-android/)

我最近在一个绝密项目上做了一些 Android 开发，希望它能改变你用手机运行的方式。

在构建这个应用程序的过程中，在[之前的一篇文章](https://simpleprogrammer.com/2010/07/20/the-hardest-thing-i-struggle-with/)中，我提到我想找到正确的，或者说完美的方式来构建一个 Android 应用程序。

我还没有找到将 Android 应用程序构建成一个漂亮整洁的设计模式的最佳方法，但是我找到了一种似乎可行的方法，它使应用程序可测试且易于维护。

不过，我相信我已经找到了在 Android 中进行单元测试的最佳方法。是的，一个大胆的声明，但我到处寻找更好的解决方案，找不到一个。



![unit test in android](img/5e393a0f16e8948ffb54e63a34dd0928.png "HTC-Android")



## 问题

所以首先介绍一下 Android 中单元测试问题的背景。在这里对我说的要有所保留，因为我不是 Android 平台专家，如果我说错了什么，请随时纠正我。

#### Android.jar

如果你从 google 下载 Android SDK，你会发现你用 SDK 得到的 android.jar 很像一个 C++头文件；它实际上不包含任何工作代码。事实上，所有的方法都被存根化，抛出一个异常，并显示消息“存根！”当你打电话给他们。多可爱啊。

真正的 android.jar 实现存在于模拟器或真正的 android 设备上。因此，如果你想实际运行任何调用任何方法的代码，或者试图构建真正的 Android 框架类，你必须在模拟器或真实设备中运行这些代码。 

#### **Dalvik VM**

当你使用 Android 时，感觉就像你在编写常规的标准 Java SE 代码，但你不是。您可能不会注意到这种差异，因为您需要的几乎所有东西都在 Java 的 Dalvik VM 实现中。

Dalvik 甚至根本不是 Java 虚拟机。没错，它运行在交叉编译上。转换为. dex 格式的类文件。**是的，它不使用 java 字节码。**

我为什么要提到这些？因为在编写单元测试时，您可能希望使用类似 JMock 的东西来模拟您的依赖关系。

你不能。这是行不通的，因为 Dalvik VM 不使用 java 字节码，所以像 JMock 这样的模仿框架所使用的反射性的酷不一样。

请注意，您尝试在 Android 项目中使用的任何外部库都可能无法工作，因为 Android 不支持完整的 Java SE 实现。它实际上是 Apache Harmony Java 实现的子集。

#### 没有主()

Android 应用程序从哪里开始运行？从活动中。基本上就是这个观点。(有些人会认为这是控制者或演示者。是的，我同意 Android 框架的观点，但是对于你的应用程序框架来说，它是视图。)

Android 应用程序定义了一个开始活动，并从那里启动。活动甚至可以从其他应用程序启动。

这往往会破坏我们大多数的 MVC、MVP、MVVP 模式架构，因为视图将是入口点，并且必须负责初始化应用程序的其余部分。(这并不完全正确，因为有一个 android.app.Application 类，它在你的应用程序第一次运行时被调用，以启动主要活动，但在大多数情况下，你不能在这里做太多事情。)

不过，本质上，您必须基于每个活动构建您的体系结构，每个活动都是它自己独立的小应用程序，入口点在活动中。这给单元测试带来了一些严重的限制。

## 把所有的放在一起

因此，如果我能简要地总结这些问题，我会说:

*   Android 框架代码必须在模拟器或设备上运行。
*   Dalvik VM 不允许我们使用我们的标准嘲讽框架。
*   我们的应用程序的入口点在视图中。

第一个问题，结合第二个问题，引导我们做出一个有趣的选择。我们应该在使用 Dalvik VM 的真实仿真器或设备上运行我们的单元测试，还是应该在 JVM 中运行它们？

这可能不是一个显而易见的问题，但让我解释一下为什么它是最相关的。

在编写应用程序时，我们将拥有与 Android 平台无关的应用程序逻辑，我们将拥有特定于 Android 平台的逻辑(绘制视图、处理 Android 操作系统事件、与 Android APIs 交互等)。)

如果我们想编写真正的单元测试，我们需要隔离我们的类并单独测试它们。我们应该能够为我们的应用程序逻辑做到这一点，而不依赖于 Android 框架。如果我们不依赖于 Android 框架，我们就不需要运行在真实的或仿真的设备上，因此我们不会受限于 Dalvik VM。

**如果我们选择在真实或仿真设备上运行我们的单元测试代码:**

*   我们将能够在我们的测试工作中使用 Android 框架 API。例如，我们可以创建新的位置对象，而不是模仿它们。
*   我们将完全忠实于代码的实际执行，因为我们将使用代码将在其上运行的真实虚拟机。
*   因为我们是在设备或模拟器上运行我们的测试，所以它们运行起来会慢很多。
*   我们将无法使用 JMock、EasyMock 或 Mockito，我们将不得不推出自己的 Mock 或使用一个羽翼未丰的 Android mocking 框架。

**如果我们选择在 PC 上的 JVM 中运行我们的单元测试代码:**

*   我们的测试代码将拥有 JVM 的全部能力，因此我们可以使用类似 JMock 的模仿框架，以及类似 [Instinct](http://code.google.com/p/instinct/) 的 BDD 框架。
*   我们将更快地运行我们的单元测试，因为他们将使用我们的 PC 而不是设备。
*   我们可以使用标准的单元测试实践，而不必继承特殊的 Android 类，或者使用特殊的 Android 测试运行程序。
*   如果我们需要在应用程序中更深层地使用任何 Android 类或服务，我们将不得不包装对实际 Android 框架的任何调用。
*   因为我们将在不同的虚拟机上运行代码，所以在运行测试和实际应用程序之间存在不同行为的风险很小。

在我的下一篇文章中，我将详细说明我选择了哪个选项以及为什么，并且给出一些如何设置和运行的详细步骤。