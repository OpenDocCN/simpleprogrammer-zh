# 危险地生活:没有安全网的重构

> 原文：<https://simpleprogrammer.com/living-dangerously-refactoring-without-a-safety-net/>

在重构代码之前进行单元测试通常是个好主意。

不过，今天我要反对这种做法，告诉你这并不总是必需的。

很多时候，应该重构的代码没有被重构，这是因为在重构之前必须有单元测试。

在许多情况下，相同的代码在多次修改后仍然没有改进，因为创建重构它所需的单元测试的工作量太大了。

我认为这是一个遗憾，因为在重构之前并不总是需要进行单元测试。



![Philippe Petit](img/573afe9a5ca7dbc356c5ff6f6a1a294e.png "Philippe Petit")



## 放弃安全网

如果你去看马戏，你会注意到有些表演下面总是有一个安全网，因为特技太危险了，总有失败的可能。

你还会注意到，有些表演没有安全网，因为即使有危险，也是极小的，因为表演者受过训练。

今天我要讲一些例子，在进行重构之前，你不一定需要有一个安全网。

**自动重构**

这是一个简单的问题，应该是相当明显的。如果您使用像 Visual Studio、Eclipse 或 IntelliJ 这样的现代 IDE，您无疑会看到我所说的“右击重构”选项。

任何这些自动重构在任何时候都是非常安全的，不用担心改变功能。这些类型的自动化重构只是简单地将算法应用到代码中，以产生期望的结果，并且在几乎所有情况下都不会改变功能。

这些重构工具你可以信赖，因为不会出现人为错误。

任何时候你都可以选择使用自动重构，那就去做吧！这是有意义的，即使你有单元测试。当我与某人合作时，我总是感到惊讶，他们正在手动重构诸如“提取方法”或“重命名”之类的东西

大多数时候，您想对代码做的任何事情都可以在自动重构菜单中找到。

**小步重构**

虽然不像自动重构那样安全，但是如果你的重构是非常小的一步，你的大脑就有更大的机会理解它并防止任何副作用。

一个很好的例子就是我在[上发布的重构移除条件](https://simpleprogrammer.com/2010/01/18/how-to-refactor-removal-of-conditions/)的帖子。

一般的想法是，如果你可以做非常简单的小步骤，这些步骤是如此琐碎，几乎没有出错的机会，那么你可以最终做一个大的重构，作为这些小变化的净效果。

这是一个判断电话。你所做的是不是一小步，取决于你自己。

我确实发现，如果我想做一个不是小步骤的重构，我通常可以把它分解成一系列小步骤，我对此很有信心。(大多数情况下，这些都是自动化重构。)

**将方法转换成类**

我讨厌大班。很多时候，每个人都害怕从一个庞大的类中取出东西，因为它很可能会崩溃，而且为那个类编写单元测试需要花费数年时间。

一个简单的步骤，极大地改进了体系结构，并让您最终创建单元测试，就是从该类中取出一大块，将其移动到一个新的类中，并保持所有逻辑的原样。

这并不总是完全干净的，你可能不得不向新的方法或新的类构造函数传递一些依赖项，但是如果你能做到，这可能是一个简单而安全的重构，它将允许你为新的类编写单元测试。

显然，这个比我之前提到的另外两个稍微危险一点，但是它也是一个巨大的“物有所值”的东西

**单元测试，或者测试代码本身**

另一个明显的例子。除非你打算编写元单元测试，否则你将不得不在这一点上冒险。你真的别无选择。

我想每个人都会同意重构单元测试很重要。那么，为什么没有人害怕重构单元测试呢？

我包括这个例子只是为了说明，你不应该害怕在没有单元测试的情况下重构代码。你可能经常在单元测试中这样做。

## 我不是在这里提倡鲁莽

我知道你们中的一些人现在吓坏了。

请放心，我的意思是不要在没有单元测试的情况下随意重构代码。我想说的是，在考虑重构的时候，要有节制。

不要仅仅因为你遵循了一个硬性规定，即你首先需要单元测试，就放弃重构。

相反，我的意思是，一些重构是如此琐碎和安全，以至于如果在因为单元测试将花费太长时间而保持代码原样或者在没有安全网的情况下重构代码之间做出选择，不要做一个…嗯…普…懦夫。动动脑子！

## 会狠狠咬你一口的东西

即使是自动重构，也有一些事情需要注意。即使那些也可能失败，给你带来各种各样的问题。

除非你在做一些疯狂的事情，否则这些问题大部分不会存在于你的代码库中。

*   如果你在 C#中使用*动态*，或者某种 PInvoke、*不安全*(指针操作)或者 COM 互操作，所有的赌注都在重命名上。
*   反思。小心这个。这真的可以踢你的性腺。如果你正在使用反射，改变一个方法名或类型可能会导致一个只有在运行时才能看到的失败。
*   代码生成。也要小心这个。如果生成的代码依赖于系统中某些功能的特定实现，重构工具不会有任何想法。
*   外部发布的接口。这是不言而喻的，但它是如此重要，我将在这里提到它。注意其他人使用你发布的 API。不管你有没有单元测试，重构已发布的 API 都会给你带来一大堆噩梦。

这个列表并不是要吓退你重构，但是如果你知道这个列表中的任何东西都在你的代码库中，在你重构之前检查一下。确保你正在重构的代码不会受到这些事情的影响。