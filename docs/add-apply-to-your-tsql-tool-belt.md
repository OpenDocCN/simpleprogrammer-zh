# 添加应用到您的 TSQL 工具带

> 原文：<https://simpleprogrammer.com/add-apply-to-your-tsql-tool-belt/>

每隔一段时间，我都会偶然发现一些我并不真正了解的 SQL 关键字，但是这些关键字非常有用。

前几天我碰到了申请，或者更确切地说是交叉申请。

在通读了关于它如何工作的文档和文章后，我在理解它时遇到了一点麻烦，因为我真的找不到一个简单的解释。



![criss-cross_1256682](img/bba3fa07787ee7ffa5f8e6a0381d71e0.png "criss-cross_1256682")



我将尽可能简单地解释它，这样你就可以马上开始使用它。

## 交叉应用如何工作

交叉应用背后的基本思想是允许您将两组数据连接在一起。

如果您理解了内部连接是如何工作的，那么您就已经理解了交叉应用。

唯一的区别是交叉应用还允许您加入一组数据，其中该组数据是创建的或依赖于第一组中的每一行。

所以基本上这意味着，对于一个普通的连接，例如，连接两个共享一个公共键的表。

我可以将我的客户表连接到我的订单表，以查看特定客户的所有订单，如下所示:

注意连接是如何对每个表中独立存在的键进行操作的。

我们可以使用交叉应用语法将它重写为完全相同的形式，如下所示:

我们可以证明这些结果集完全相同，方法是使用 EXCEPT 来确保一个结果集中没有不在另一个结果集中的行，然后翻转它，如下所示:

只需再次运行这个精确的查询，将 EXCEPT 上面的 SQL 与下面的 SQL 交换，并确保它也没有结果。如果这两个查询都没有结果，那么您知道每个查询的结果是相同的，因为 EXCEPT 将显示顶部查询中的结果，而不是底部查询中的结果。

## 那么交叉应用什么时候有用呢？

还记得我说过它能做的不仅仅是简单的连接吗？连接仅限于连接可以相互独立查询的两组数据。

如果我说给我每个客户最近的三个订单会怎么样？

花一分钟时间考虑一下如何编写这个查询。去吧，试着去做。我会等的。

有几种方法可以在不使用交叉应用的情况下做到这一点，但没有一种方法真的非常容易或执行得非常好。

使用交叉应用很简单:

因此，每当您有一些想要连接的数据，但由于您尝试连接的数据不能很好地映射到单个键，而被迫执行某种子查询时，CROSS APPLY 就非常有用。

CROSS APPLY 有用的另一个实例是，当您进行子选择时，您希望在最终查询中使用多个值。

例如，如果您从 Order Details 表中进行子选择，以匹配数量大于 5 的订单 id，那么该子选择将需要恰好返回一列，以便您在 where 子句中使用它。如果您想使用子选择中的其他列，您必须为这些列中的每一列再做一次子选择。

如果您第一次尝试将子选择重写为一个连接，但发现不能，那么您可以将其编写为一个交叉应用。

## 如何知道何时使用交叉应用

没有一个很好的可靠规则可以用来确定何时应该使用交叉应用，但是当您试图调优查询并且很难构建查询时，了解交叉应用及其工作原理可以帮助您。这是你可以尝试的另一个选择。

以下是您可能需要使用交叉应用时的一些通用指南:

*   您要联接的结果集在某种程度上与第一个结果集中的数据相关的查询。(例如:第一个表格中的一列告诉您要在第二个表格中获取多少行)
*   正在执行子查询，但需要子查询中的多个值的查询
*   任何使用公共表表达式(CTE)的地方都可能被重写为交叉应用
*   一种查询，它有一大组要连接然后过滤掉的数据。您可以将其更改为交叉应用，在交叉应用语句中执行筛选。
*   任何时候你试图连接一个表函数(这实际上就是创建 CROSS APPLY 的目的。)